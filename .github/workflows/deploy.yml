name: Deploy Barbershop Backend

on:
  push:
    branches: [ main, master ]

env:
  NODE_VERSION: '20'
  PM2_APP_NAME: 'barbershop-backend'

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.PORT }}
        script: |
          echo "ğŸš€ Starting deployment..."
          
          # Source common paths
          export PATH=$PATH:/usr/local/bin:/usr/bin:/bin:~/.nvm/versions/node/*/bin:~/node_modules/.bin
          source ~/.bashrc 2>/dev/null || true
          source ~/.profile 2>/dev/null || true
          source ~/.nvm/nvm.sh 2>/dev/null || true
          
          # Navigate to project directory
          cd ~/project/Back-End-Sistem-Reservasi-Barbershop/ || {
            echo "âŒ Could not find project directory"
            echo "ğŸ“‚ Available directories in project:"
            ls -la ~/project/
            echo "ğŸ“‚ Available directories in home:"
            ls -la ~/
            exit 1
          }
          
          # Check current directory
          echo "ğŸ“ Current directory: $(pwd)"
          echo "ğŸ“‹ Current files:"
          ls -la
          
          # Check Node.js and npm
          echo "ğŸ” Checking Node.js and npm..."
          which node || echo "âŒ Node.js not found in PATH"
          which npm || echo "âŒ npm not found in PATH"
          which pm2 || echo "âŒ PM2 not found in PATH"
          
          # Try to find Node.js installation
          if ! command -v node >/dev/null 2>&1; then
            echo "ğŸ” Searching for Node.js installation..."
            NODE_PATH=$(find /usr -name "node" -type f 2>/dev/null | head -1)
            if [ -n "$NODE_PATH" ]; then
              echo "âœ… Found Node.js at: $NODE_PATH"
              export PATH=$(dirname $NODE_PATH):$PATH
            else
              echo "âŒ Node.js not found. Please install Node.js on the server."
              exit 1
            fi
          fi
          
          # Try to find npm
          if ! command -v npm >/dev/null 2>&1; then
            echo "ğŸ” Searching for npm..."
            NPM_PATH=$(find /usr -name "npm" -type f 2>/dev/null | head -1)
            if [ -n "$NPM_PATH" ]; then
              echo "âœ… Found npm at: $NPM_PATH"
              export PATH=$(dirname $NPM_PATH):$PATH
            else
              echo "âŒ npm not found. Please install npm on the server."
              exit 1
            fi
          fi
          
          # Show versions
          echo "ğŸ“‹ Environment info:"
          node --version || echo "âŒ Node.js not working"
          npm --version || echo "âŒ npm not working"
          pm2 --version || echo "âš ï¸ PM2 not installed"
          
          # Check git status
          echo "ğŸ“‹ Git status:"
          git status || echo "âš ï¸ Not a git repository or git not available"
          
          # Backup current state
          echo "ğŸ’¾ Creating backup..."
          cp -r . ../backup-$(date +%Y%m%d-%H%M%S) 2>/dev/null || echo "âš ï¸ Backup failed, continuing..."
          
          # Pull latest changes
          echo "ğŸ“¥ Pulling latest changes..."
          git fetch origin main 2>/dev/null || {
            echo "âš ï¸ Git fetch failed, trying alternative methods..."
            git pull origin main || echo "âŒ Git pull failed"
          }
          git reset --hard origin/main 2>/dev/null || echo "âš ï¸ Git reset failed"
          
          # Install dependencies
          echo "ğŸ“¦ Installing dependencies..."
          npm install --production || {
            echo "âŒ npm install failed, trying npm ci..."
            npm ci --production || {
              echo "âŒ All npm install methods failed"
              echo "ğŸ” Checking npm configuration..."
              npm config list || echo "âŒ npm config failed"
              exit 1
            }
          }
          
          # Check if server.js exists
          if [ ! -f "server.js" ]; then
            echo "âŒ server.js not found!"
            echo "ğŸ“‚ Files in current directory:"
            ls -la
            exit 1
          fi
          
          # Install PM2 if not found
          if ! command -v pm2 >/dev/null 2>&1; then
            echo "ğŸ“¦ Installing PM2..."
            npm install -g pm2 || {
              echo "âŒ Failed to install PM2 globally, trying local install..."
              npm install pm2 || {
                echo "âŒ Failed to install PM2"
                exit 1
              }
              export PATH=$PATH:./node_modules/.bin
            }
          fi
          
          # Check PM2 status
          echo "ğŸ” Checking PM2 status..."
          pm2 list || {
            echo "âŒ PM2 command failed"
            exit 1
          }
          
          # Stop existing process if running
          echo "ğŸ›‘ Stopping existing PM2 process..."
          pm2 stop ${{ env.PM2_APP_NAME }} 2>/dev/null || echo "â„¹ï¸ No existing process to stop"
          
          # Delete existing process
          pm2 delete ${{ env.PM2_APP_NAME }} 2>/dev/null || echo "â„¹ï¸ No existing process to delete"
          
          # Start PM2 application
          echo "ğŸ”„ Starting PM2 application..."
          pm2 start server.js --name ${{ env.PM2_APP_NAME }} --env production || {
            echo "âŒ PM2 start failed"
            echo "ğŸ“‹ Current directory contents:"
            ls -la
            echo "ğŸ“‹ PM2 logs:"
            pm2 logs || true
            exit 1
          }
          
          # Save PM2 configuration
          echo "ğŸ’¾ Saving PM2 configuration..."
          pm2 save
          
          # Health check
          echo "ğŸ¥ Performing health check..."
          sleep 5
          if pm2 describe ${{ env.PM2_APP_NAME }} | grep -q "online"; then
            echo "âœ… Application is running successfully"
          else
            echo "âš ï¸ Application might not be running properly"
            echo "ğŸ“‹ PM2 status:"
            pm2 show ${{ env.PM2_APP_NAME }} || true
            echo "ğŸ“‹ PM2 logs:"
            pm2 logs ${{ env.PM2_APP_NAME }} --lines 20 || true
          fi
          
          # Show final status
          echo "âœ… Deployment completed!"
          echo "ğŸ“Š Final PM2 status:"
          pm2 list