name: Deploy Barbershop Backend

on:
  push:
    branches: [ main, master ]

env:
  NODE_VERSION: '20'
  PM2_APP_NAME: 'barbershop-backend'

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.PORT }}
        script: |
          echo "ğŸš€ Starting deployment..."
          
          # Navigate to project directory
          cd ~/project/Back-End-Sistem-Reservasi-Barbershop/ || {
            echo "âŒ Could not find project directory"
            echo "ğŸ“‚ Available directories in project:"
            ls -la ~/project/
            echo "ğŸ“‚ Available directories in home:"
            ls -la ~/
            exit 1
          }
          
          # Check current directory and git status
          echo "ğŸ“ Current directory: $(pwd)"
          echo "ğŸ“‹ Current files:"
          ls -la
          
          # Check git status
          echo "ğŸ“‹ Git status:"
          git status || echo "âš ï¸ Not a git repository or git not available"
          
          # Backup current state
          echo "ğŸ’¾ Creating backup..."
          cp -r . ../backup-$(date +%Y%m%d-%H%M%S) 2>/dev/null || echo "âš ï¸ Backup failed, continuing..."
          
          # Pull latest changes
          echo "ğŸ“¥ Pulling latest changes..."
          git fetch origin main 2>/dev/null || {
            echo "âš ï¸ Git fetch failed, trying alternative methods..."
            git pull origin main || echo "âŒ Git pull failed"
          }
          git reset --hard origin/main 2>/dev/null || echo "âš ï¸ Git reset failed"
          
          # Install dependencies
          echo "ğŸ“¦ Installing dependencies..."
          npm install --production || {
            echo "âŒ npm install failed, trying npm ci..."
            npm ci --production || echo "âŒ All npm install methods failed"
          }
          
          # Check if server.js exists
          if [ ! -f "server.js" ]; then
            echo "âŒ server.js not found!"
            echo "ğŸ“‚ Files in current directory:"
            ls -la
            exit 1
          fi
          
          # Check PM2 status
          echo "ğŸ” Checking PM2 status..."
          pm2 list || {
            echo "âš ï¸ PM2 not found, installing..."
            npm install -g pm2
          }
          
          # Stop existing process if running
          echo "ğŸ›‘ Stopping existing PM2 process..."
          pm2 stop ${{ env.PM2_APP_NAME }} 2>/dev/null || echo "â„¹ï¸ No existing process to stop"
          
          # Start/Restart PM2 application
          echo "ğŸ”„ Starting PM2 application..."
          pm2 start server.js --name ${{ env.PM2_APP_NAME }} --env production || {
            echo "âŒ PM2 start failed, trying alternative approach..."
            pm2 delete ${{ env.PM2_APP_NAME }} 2>/dev/null || true
            pm2 start server.js --name ${{ env.PM2_APP_NAME }}
          }
          
          # Save PM2 configuration
          echo "ğŸ’¾ Saving PM2 configuration..."
          pm2 save
          
          # Health check
          echo "ğŸ¥ Performing health check..."
          sleep 5
          if pm2 describe ${{ env.PM2_APP_NAME }} | grep -q "online"; then
            echo "âœ… Application is running successfully"
          else
            echo "âš ï¸ Application might not be running properly"
            echo "ğŸ“‹ PM2 logs:"
            pm2 logs ${{ env.PM2_APP_NAME }} --lines 10
          fi
          
          # Show final status
          echo "âœ… Deployment completed!"
          echo "ğŸ“Š Final PM2 status:"
          pm2 list
          pm2 show ${{ env.PM2_APP_NAME }}